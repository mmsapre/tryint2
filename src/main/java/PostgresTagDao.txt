package com.mmsapre.semantic.store;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

import java.util.*;

@Component
public class PostgresTagDao {

  private final JdbcTemplate jdbc;
  private final ObjectMapper om;

  public PostgresTagDao(JdbcTemplate jdbc, ObjectMapper om) {
    this.jdbc = jdbc;
    this.om = om;
  }

  public List<Row> fetchAll() {
    return jdbc.query("select dataset, entity_id, tags::text from semantic_entity_tags",
        (rs, i) -> new Row(rs.getString(1), rs.getString(2), rs.getString(3)));
  }

  public record Row(String dataset, String entityId, String tagsJson) {}

  public Map<String, Object> parseTags(String tagsJson) {
    try {
      return om.readValue(tagsJson, Map.class);
    } catch (Exception e) {
      return Map.of();
    }
  }
}
