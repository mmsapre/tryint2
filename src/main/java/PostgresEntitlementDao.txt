package com.mmsapre.semantic.store;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

import java.util.*;

@Component
public class PostgresEntitlementDao {

  private final JdbcTemplate jdbc;
  private final ObjectMapper om;

  public PostgresEntitlementDao(JdbcTemplate jdbc, ObjectMapper om) {
    this.jdbc = jdbc;
    this.om = om;
  }

  public List<Row> fetchAll() {
    return jdbc.query("select entity_type, entity_id, rules::text from semantic_entity_entitlements",
        (rs, i) -> new Row(rs.getString(1), rs.getString(2), rs.getString(3)));
  }

  public void upsert(String entityType, String entityId, Map<String,Object> rules) {
    try {
      String json = om.writeValueAsString(rules);
      jdbc.update("""
          insert into semantic_entity_entitlements(entity_type, entity_id, rules)
          values (?, ?, ?::jsonb)
          on conflict(entity_type, entity_id) do update
            set rules = excluded.rules
          """, entityType, entityId, json);
    } catch (Exception e) {
      throw new RuntimeException(e);
    }
  }

  public record Row(String entityType, String entityId, String rulesJson) {}

  public Map<String, Object> parse(String json) {
    try { return om.readValue(json, Map.class); } catch (Exception e) { return Map.of(); }
  }
}
