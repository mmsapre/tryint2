package com.mmsapre.semantic.store;

import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

import java.util.HashMap;
import java.util.Map;

@Component
public class GraphEdgeWeightDao {

  private final JdbcTemplate jdbc;

  public GraphEdgeWeightDao(JdbcTemplate jdbc) {
    this.jdbc = jdbc;
  }

  public Map<String, Double> loadAll() {
    Map<String, Double> out = new HashMap<>();
    jdbc.query("select edge_key, weight from semantic_graph_edge_weight",
        rs -> out.put(rs.getString(1), rs.getDouble(2)));
    return out;
  }

  public void upsert(String edgeKey, double weight) {
    jdbc.update("""
        insert into semantic_graph_edge_weight(edge_key, weight)
        values (?, ?)
        on conflict(edge_key) do update
          set weight = excluded.weight,
              updated_at = now()
        """, edgeKey, weight);
  }
}
